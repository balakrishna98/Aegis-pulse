<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#0b1430" />
  <meta http-equiv="Content-Security-Policy"
        content="default-src 'self';
           script-src 'self' 'unsafe-inline';
           style-src  'self' 'unsafe-inline';
           img-src    'self' data:;
           connect-src 'self';
           font-src   'self';
           media-src  'self'">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <title>Aegis Pulse ¬∑ Piano Edition (Mobile-Optimized)</title>
  <style>
    :root{
      --bg:#060915; --bg2:#0b1430; --fg:#eaf1ff; --muted:#94a2bb;
      --note:#54f0a6; --danger:#ff6a6a; --accent:#3aa8ff; --accent2:#2aa7ff; --glow:#7fd0ff;
      --glass: rgba(255,255,255,.07); --glass-strong: rgba(255,255,255,.12);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--fg);
      background: radial-gradient(1400px 900px at 18% 12%, var(--bg2), var(--bg));
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      display:flex; align-items:center; justify-content:center; overflow:hidden;
      -webkit-user-select:none; user-select:none; -webkit-touch-callout:none; -webkit-tap-highlight-color:transparent;
      touch-action:none;
    }
    #wrap{ width:min(100vw,950px); height:min(100vh,1200px); aspect-ratio:9/16; position:relative }
    canvas{ width:100%; height:100%; display:block; border-radius:22px; box-shadow:0 22px 60px rgba(0,0,0,.45) }

    /* HUD */
    .hud{ position:absolute; inset:0; pointer-events:none; padding:12px; display:flex; flex-direction:column; justify-content:space-between }
    .rows{display:flex; flex-direction:column; gap:8px}
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .pill{ background:var(--glass); padding:8px 12px; border-radius:999px; font-weight:800; backdrop-filter:saturate(1.2) blur(6px); border:1px solid #ffffff22; box-shadow:0 8px 20px rgba(0,0,0,.18)}
    .muted{ color:var(--muted); font-weight:700 }
    .charges{ display:flex; gap:6px; align-items:center }
    .pip{ width:18px; height:18px; border-radius:999px; background:#ffffff1f; outline:1px solid #ffffff30; position:relative; overflow:hidden }
    .pip>i{ position:absolute; left:0; top:0; bottom:0; width:0%; background:linear-gradient(180deg,#3af,#19a0ff) }

    .center{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); text-align:center; pointer-events:auto; z-index:4 }
    .title{ font-weight:900; font-size:28px; letter-spacing:.6px; background:linear-gradient(90deg,#bfe2ff,#53b4ff,#a7faff); -webkit-background-clip:text; background-clip:text; color:transparent; filter:drop-shadow(0 4px 24px #2aa7ff66) }
    .subtitle{ color:var(--muted); margin-top:6px }
    .footer{ font-size:12px; color:var(--muted); text-align:center; padding-bottom:8px }

    /* Buttons */
    .btn{ pointer-events:auto; border:0; padding:10px 14px; border-radius:999px; font-weight:900; font-size:14px; cursor:pointer; background:var(--glass); color:#fff; box-shadow:0 8px 18px rgba(0,0,0,.22); border:1px solid #ffffff26; transition:transform .08s ease, box-shadow .2s ease, background .2s ease; display:inline-flex; align-items:center; gap:8px }
    .btn .icon{line-height:1}
    .btn:hover{ transform:translateY(-1px); box-shadow:0 12px 26px rgba(0,0,0,.28); background:var(--glass-strong) }
    .play{ pointer-events:auto; border:0; padding:14px 24px; border-radius:16px; font-weight:900; font-size:16px; background:linear-gradient(180deg,#3a7bff,#2aa7ff); color:#fff; box-shadow:0 14px 30px #2aa7ff55, inset 0 0 0 1px #ffffff5a; cursor:pointer; transition:transform .08s ease, filter .2s ease }
    .play:hover{ transform:translateY(-1px); filter:brightness(1.05) }

    /* Pop text */
    .pop{ position:absolute; left:50%; top:46%; transform:translate(-50%,-50%); pointer-events:none; font-weight:900; font-size:24px; opacity:0; color:#dff2ff; text-shadow:0 0 22px #7fd0ff99, 0 4px 16px #0008 }
    .pop.show{ animation:pop 700ms ease forwards }
    @keyframes pop{ 0%{opacity:0; transform:translate(-50%,-50%) scale(.6)} 35%{opacity:1; transform:translate(-50%,-50%) scale(1.08)} 100%{opacity:0; transform:translate(-50%,-78%) scale(1)} }

    /* Game Over + dim backdrop */
    #over{ position:absolute; left:50%; top:50%; transform:translate(-50%,-50%) scale(.96); opacity:0; display:none; z-index:3 }
    #over.show{ display:block; animation:overIn 420ms cubic-bezier(.2,.8,.2,1) forwards }
    @keyframes overIn{ 0%{opacity:0; transform:translate(-50%,-54%) scale(.9)} 60%{opacity:1; transform:translate(-50%,-50%) scale(1.03)} 100%{opacity:1; transform:translate(-50%,-50%) scale(1)} }
    .over-card{ pointer-events:auto; background:rgba(20,26,42,.92); border:1px solid #9ab7ff33; border-radius:20px; padding:18px 18px 14px; box-shadow:0 26px 70px rgba(0,0,0,.55), inset 0 1px 0 #ffffff22; backdrop-filter: blur(12px) saturate(1.2); min-width:260px; text-align:center }
    .over-title{ font-weight:900; font-size:30px; letter-spacing:.6px; line-height:1.1; background:linear-gradient(90deg,#eaf4ff,#8ec8ff); -webkit-background-clip:text; background-clip:text; color:transparent; text-shadow:0 6px 28px #1a6aff66 }
    .stats{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:12px 0 8px }
    .stat{ background:#ffffff14; border:1px solid #ffffff26; border-radius:14px; padding:10px 12px; text-align:center }
    .stat .lbl{ color:#a9b6cc; font-size:11px; font-weight:800; letter-spacing:.06em; text-transform:uppercase }
    .stat .val{ font-weight:900; font-size:20px; margin-top:2px }
    .btn-row{ display:flex; gap:10px; justify-content:center }
    .backdrop{ position:absolute; inset:0; border-radius:22px; background:radial-gradient(60% 50% at 50% 45%, rgba(10,14,26,.86), rgba(6,9,21,.78)); backdrop-filter: blur(2px); box-shadow: inset 0 0 0 1px #ffffff10; display:none; z-index:2 }

    /* Pause curtain */
    .curtain{ position:absolute; inset:0; background:rgba(8,12,24,.44); backdrop-filter:blur(3px); border-radius:22px; display:none; align-items:center; justify-content:center; gap:16px; pointer-events:auto; z-index:4 }
    .curtain.show{ display:flex }

    /* Mobile tweaks & responsive HUD */
    @media (max-width:560px){
      .hud{ padding-top:calc(12px + env(safe-area-inset-top)) }
      .rows{gap:6px}
      .row{ gap:6px; }
      .row .pill{ font-size:12px; padding:6px 10px }
      .charges .pip{ width:14px; height:14px }
      .btn{ font-size:12px; padding:6px 10px }
      /* Hide labels on tight screens - keep icons only */
      .btn .label{ display:none }
    }
  </style>
</head>
<body>
<div id="wrap">
  <canvas id="c" width="540" height="960" aria-label="Aegis Pulse game canvas"></canvas>

  <div class="hud" aria-live="polite">
    <!-- TWO ROWS -->
    <div class="rows">
      <div class="row" id="rowTop">
        <div id="score" class="pill">Score: 0</div>
        <div id="time" class="pill">0s</div>
        <div class="pill muted">High: <span id="hi">0</span></div>
        <div class="pill">HP: <span id="hp">3</span></div>
      </div>

      <div class="row" id="rowBottom">
        <div class="pill charges">
          Charges:
          <span class="pip"><i id="p0"></i></span>
          <span class="pip"><i id="p1"></i></span>
          <span class="pip"><i id="p2"></i></span>
        </div>
        <div id="levelDisplay" class="pill">Level: 1</div>

        <div class="row" style="margin-left:auto; pointer-events:auto" role="group" aria-label="Game controls">
          <button id="muteBtn" class="btn" title="Mute / Unmute">
            <span class="icon" id="muteIcon">üîä</span>
            <span class="label" id="muteLabel">Sound</span>
          </button>
          <button id="pauseBtn" class="btn" title="Pause / Resume">
            <span class="icon">‚è∏Ô∏è</span>
            <span class="label">Pause</span>
          </button>
        </div>
      </div>
    </div>

    <div class="footer">Tap / click / Space to emit a pulse ‚Ä¢ Deflect red shards ‚Ä¢ Collect green notes</div>
  </div>

  <div id="menu" class="center">
    <div class="title">AEGIS PULSE</div>
    <div class="subtitle">Guard the core. Your only weapon is timing.</div>
    <div style="height:14px"></div>
    <button class="play" id="btnPlay">Play</button>
    <div style="height:10px"></div>
    <div class="subtitle" style="font-size:12px">Press <b>Space</b> to pulse ‚Ä¢ <b>P</b> to pause</div>
  </div>

  <div id="backdrop" class="backdrop" aria-hidden="true"></div>

  <div id="over" class="center" style="display:none">
    <div class="over-card">
      <div class="over-title">Game Over</div>
      <div class="stats">
        <div class="stat"><div class="lbl">Score</div><div class="val" id="finalScore">0</div></div>
        <div class="stat"><div class="lbl">High</div><div class="val" id="finalHigh">0</div></div>
      </div>
      <div class="btn-row">
        <button class="play" id="btnRetry">Try Again</button>
      </div>
      <div style="margin-top:12px; font-size:11px; color:#88a;">¬© 2025 Bala Krishna Mamidala. All Rights Reserved.</div>
    </div>
  </div>

  <div id="curtain" class="curtain"><button class="play" id="resumeBtn">‚ñ∂ Resume</button></div>

  <div id="pop" class="pop" aria-hidden="true">+0</div>
</div>

<script>
  /* ===== Core setup (Android-friendly) ===== */
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d', { alpha:false, desynchronized:true });

  function computeDPR(){
    const dpr = window.devicePixelRatio || 1;
    const w = Math.min(window.innerWidth, window.innerHeight);
    if (w <= 360) return Math.min(1.5, dpr);
    if (w <= 412) return Math.min(1.75, dpr);
    return Math.min(2, dpr);
  }
  let DPR = computeDPR();

  const ui = {
    score: document.getElementById('score'),
    time: document.getElementById('time'),
    hi: document.getElementById('hi'),
    hp: document.getElementById('hp'),
    menu: document.getElementById('menu'),
    over: document.getElementById('over'),
    finalScore: document.getElementById('finalScore'),
    finalHigh: document.getElementById('finalHigh'),
    btnPlay: document.getElementById('btnPlay'),
    btnRetry: document.getElementById('btnRetry'),
    muteBtn: document.getElementById('muteBtn'),
    pauseBtn: document.getElementById('pauseBtn'),
    resumeBtn: document.getElementById('resumeBtn'),
    pips: [document.getElementById('p0'), document.getElementById('p1'), document.getElementById('p2')],
    levelDisplay: document.getElementById('levelDisplay'),
    backdrop: document.getElementById('backdrop'),
    curtain: document.getElementById('curtain'),
    pop: document.getElementById('pop'),
    muteIcon: document.getElementById('muteIcon'),
    muteLabel: document.getElementById('muteLabel'),
  };

  // Safe localStorage
  const safeStorage = {
    get(key, fallback){ try{ const v = localStorage.getItem(key); return v==null?fallback:JSON.parse(v); }catch(e){ return fallback; } },
    set(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch(e){} }
  };

  let state = 'menu';
  const rand=(a,b)=>a+Math.random()*(b-a);
  const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
  const dist=(ax,ay,bx,by)=>Math.hypot(ax-bx,ay-by);
  const TAU=Math.PI*2;

  const world = {
    w: canvas.width, h: canvas.height,
    cx: canvas.width*0.5, cy: canvas.height*0.55,
    t:0, dt:0, last:performance.now(),
    score:0, best:Number(safeStorage.get('aegis-hi', 0)||0),
    hp:3,
    centerR: 19*DPR,
    charges: 3, chargeFill: 3,
    chargeRegen: 0.36,
    pulses:[], shards:[], notes:[], particles:[], debris:[], smokes:[], fireballs:[],
    level:1, nextLevelT:20, shake:0,
    starsA:[], starsB:[], flash:0,
  };

  /* ===== Piano BGM ===== */
  const BGM = (()=>{
    let ac=null, master=null, isMuted=false, running=false, timer=null;
    const state={volume:0.22};
    const scale=[0,2,4,5,7,9,11];
    const base=261.63;
    const hz=s=>base*Math.pow(2,s/12);
    function pianoTone(freq,t,dur,gain=0.16){
      if(!ac) return;
      const o=ac.createOscillator(), g=ac.createGain();
      o.type='sine'; o.frequency.setValueAtTime(freq,t);
      g.gain.setValueAtTime(0.0001,t);
      g.gain.linearRampToValueAtTime(gain,t+0.02);
      g.gain.linearRampToValueAtTime(gain*0.7,t+0.18);
      g.gain.exponentialRampToValueAtTime(0.0001,t+dur);
      o.connect(g).connect(master);
      o.start(t); o.stop(t+dur+0.05);
    }
    function schedule(){
      if(!ac) return;
      const now=ac.currentTime, bar=5;
      const root=scale[Math.floor(Math.random()*scale.length)];
      [root, root+4, root+7, root+12].forEach((s,i)=>pianoTone(hz(s), now+0.15*i, bar*0.9, 0.14));
      for(let i=0;i<3;i++){
        const s=scale[Math.floor(Math.random()*scale.length)]+(Math.random()<0.6?12:0);
        const t=now+1.2+i*(bar/3);
        pianoTone(hz(s), t, 1.0, 0.12);
      }
    }
    function init(){ if(ac) return; const AC=window.AudioContext||window.webkitAudioContext; if(!AC) return; ac=new AC(); master=ac.createGain(); master.gain.value=state.volume; master.connect(ac.destination); }
    function applyMute(){
      if(!master) return;
      master.gain.value=isMuted?0:state.volume;
      // Update icon + label without altering layout/behavior
      if (ui.muteIcon) ui.muteIcon.textContent = isMuted ? 'üîá' : 'üîä';
      if (ui.muteLabel) ui.muteLabel.textContent = isMuted ? 'Muted' : 'Sound';
    }
    function start(){ if(running) return; init(); if(!ac) return; ac.resume&&ac.resume(); schedule(); timer=setInterval(schedule,5000); running=true; applyMute(); }
    function stop(){ if(!running||!ac) return; clearInterval(timer); timer=null; running=false; if(master){ const now=ac.currentTime; try{ master.gain.cancelScheduledValues(now); master.gain.setValueAtTime(master.gain.value, now); master.gain.linearRampToValueAtTime(0.0001, now+0.4);}catch(e){} } }
    function fadeCrackle(){ /* no-op */ }
    return { start, stop, toggle(){ isMuted=!isMuted; applyMute(); }, fadeCrackle };
  })();

  /* ===== Backdrop & stars ===== */
  function initStars(){
    world.starsA.length = world.starsB.length = 0;
    const a = Math.round((world.w*world.h)/36000);
    const b = Math.round(a/2);
    for(let i=0;i<a;i++) world.starsA.push({x:Math.random()*world.w, y:Math.random()*world.h, s:rand(0.6,1.6)});
    for(let i=0;i<b;i++) world.starsB.push({x:Math.random()*world.w, y:Math.random()*world.h, s:rand(1.2,2.0)});
  }
  function drawBackdrop(t){
    const dx=Math.sin(t*0.03)*6*DPR, dy=Math.cos(t*0.04)*6*DPR;
    const g=ctx.createRadialGradient(world.cx,world.cy,40*DPR, world.cx,world.cy, Math.max(world.w,world.h)*0.75);
    g.addColorStop(0,'rgba(80,140,255,0.20)'); g.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle='#060915'; ctx.fillRect(0,0,world.w,world.h);
    ctx.globalCompositeOperation='lighter';
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(world.cx,world.cy,Math.max(world.w,world.h),0,TAU); ctx.fill();
    ctx.globalCompositeOperation='source-over';
    ctx.fillStyle='#a8c7ff22';
    for(const s of world.starsA) ctx.fillRect((s.x+dx*0.3+world.w)%world.w,(s.y+dy*0.3+world.h)%world.h,s.s,s.s);
    ctx.fillStyle='#d9e9ff44';
    for(const s of world.starsB) ctx.fillRect((s.x+dx*0.6+world.w)%world.w,(s.y+dy*0.6+world.h)%world.h,s.s,s.s);
    ctx.globalAlpha=0.10; ctx.beginPath();
    const step=44*DPR, off=(performance.now()/1000*18)%step;
    for(let y=-off;y<world.h;y+=step){ ctx.moveTo(0,y); ctx.lineTo(0+world.w,y); }
    for(let x=-off;x<world.w;x+=step){ ctx.moveTo(x,0); ctx.lineTo(x,world.h); }
    ctx.strokeStyle='#ffffff10'; ctx.lineWidth=1*DPR; ctx.stroke(); ctx.globalAlpha=1;
    if(world.flash>0){ ctx.globalAlpha=Math.min(1,world.flash); ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,world.w,world.h); ctx.globalAlpha=1; world.flash*=0.85; }
  }

  /* ===== Entities ===== */
  class Pulse{
    constructor(){ this.r=0; this.width=9*DPR; this.speed=420*DPR; this.alive=true; this.age=0; this.life=1.1; }
    update(dt){ this.age+=dt; this.r+=this.speed*dt; this.life-=dt; if(this.r>Math.max(world.w,world.h)+80 || this.life<=0) this.alive=false; }
    draw(){
      const base=this.width; const cols=['#bfe7ff','#82d3ff','#3aa8ff'];
      for(let i=2;i>=0;i--){ ctx.strokeStyle=cols[i]; ctx.globalAlpha=[0.10,0.18,0.92][i]; ctx.lineWidth=base+i*7*DPR; ctx.beginPath(); ctx.arc(world.cx,world.cy,this.r,0,TAU); ctx.stroke(); }
      ctx.globalAlpha=1;
    }
  }
  class Shard{
    constructor(){
      const margin=26*DPR, side=Math.floor(rand(0,4));
      if(side===0){ this.x=rand(0,world.w); this.y=-margin; }
      else if(side===1){ this.x=world.w+margin; this.y=rand(0,world.h); }
      else if(side===2){ this.x=rand(0,world.w); this.y=world.h+margin; }
      else { this.x=-margin; this.y=rand(0,world.h); }
      const ang=Math.atan2(world.cy-this.y, world.cx-this.x);
      const spd=rand(70,106)*DPR+(world.level-1)*14*DPR;
      this.vx=Math.cos(ang)*spd; this.vy=Math.sin(ang)*spd;
      this.r=9*DPR; this.alive=true; this.reflected=false; this.hitCooldown=0; this.trail=[];
    }
    update(dt){
      this.hitCooldown=Math.max(0,this.hitCooldown-dt);
      this.x+=this.vx*dt; this.y+=this.vy*dt;
      this.trail.push({x:this.x,y:this.y}); if(this.trail.length>8) this.trail.shift();
      if(!this.reflected && dist(this.x,this.y,world.cx,world.cy)<=world.centerR){ this.alive=false; damage(); }
      const M=34*DPR;
      if(this.x<-M||this.x>world.w+M||this.y<-M||this.y>world.h+M){ if(this.reflected) addScore(10+3*world.level); this.alive=false; }
    }
    draw(){
      if(this.trail.length>1){
        for(let i=0;i<this.trail.length-1;i++){
          const a=this.trail[i], b=this.trail[i+1];
          ctx.strokeStyle=this.reflected?'#aef3ff66':'#ff8a8a55';
          ctx.lineWidth=(this.r*0.8)*(i/this.trail.length);
          ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
        }
      }
      const ang=Math.atan2(this.vy,this.vx)+(this.reflected?Math.PI:0);
      ctx.save(); ctx.translate(this.x,this.y); ctx.rotate(ang);
      const s=this.r; ctx.fillStyle=this.reflected?'#bff4ff':'#ff6a6a';
      ctx.beginPath(); ctx.moveTo(s*1.6,0); ctx.lineTo(-s*0.9,-s*0.9); ctx.lineTo(-s*0.9,s*0.9); ctx.closePath(); ctx.fill();
      ctx.restore();
    }
  }
  class Note{
    constructor(){
      const radius=rand(world.centerR+86*DPR, Math.min(world.w,world.h)*0.46), theta=rand(0,TAU);
      this.x=world.cx+Math.cos(theta)*radius; this.y=world.cy+Math.sin(theta)*radius;
      this.vx=rand(-22,22)*DPR; this.vy=rand(-22,22)*DPR; this.r=7.2*DPR; this.alive=true;
    }
    update(dt){
      this.x+=this.vx*dt; this.y+=this.vy*dt;
      if(this.x<this.r||this.x>world.w-this.r) this.vx*=-1;
      if(this.y<this.r||this.y>world.h-this.r) this.vy*=-1;
    }
    draw(){
      ctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--note')||'#54f0a6';
      ctx.beginPath(); ctx.arc(this.x,this.y,this.r,0,TAU); ctx.fill();
      ctx.strokeStyle='#a9ffd4'; ctx.lineWidth=2*DPR; ctx.stroke();
    }
  }
  class Particle{
    constructor(x,y,c){ this.x=x; this.y=y; this.vx=rand(-110,110)*DPR; this.vy=rand(-110,110)*DPR; this.life=0.38; this.c=c; }
    update(dt){ this.life-=dt; this.x+=this.vx*dt; this.y+=this.vy*dt; this.vx*=0.9; this.vy*=0.9; }
    draw(){ ctx.globalAlpha=Math.max(0,this.life/0.38); ctx.fillStyle=this.c; ctx.fillRect(this.x,this.y,2*DPR,2*DPR); ctx.globalAlpha=1; }
  }
  class Debris{
    constructor(){ const ang=rand(0,TAU), spd=rand(110,240)*DPR; this.x=world.cx; this.y=world.cy; this.vx=Math.cos(ang)*spd; this.vy=Math.sin(ang)*spd; this.rot=rand(0,TAU); this.vr=rand(-3,3); this.life=rand(0.5,0.85); this.size=rand(3,6)*DPR; }
    update(dt){ this.life-=dt; this.x+=this.vx*dt; this.y+=this.vy*dt; this.vx*=0.985; this.vy*=0.985; this.rot+=this.vr*dt; }
    draw(){ ctx.save(); ctx.translate(this.x,this.y); ctx.rotate(this.rot); ctx.fillStyle='#e6f5ff'; ctx.globalAlpha=Math.max(0,this.life/0.85); const s=this.size; ctx.beginPath(); ctx.moveTo(s,0); ctx.lineTo(-s*0.6,-s*0.6); ctx.lineTo(-s*0.6,s*0.6); ctx.closePath(); ctx.fill(); ctx.restore(); ctx.globalAlpha=1; }
  }
  class Smoke{
    constructor(){ const ang=rand(0,TAU), spd=rand(18,54)*DPR; this.x=world.cx; this.y=world.cy; this.vx=Math.cos(ang)*spd; this.vy=Math.sin(ang)*spd; this.r=rand(8,16)*DPR; this.life=rand(0.8,1.3); }
    update(dt){ this.life-=dt; this.x+=this.vx*dt; this.y+=this.vy*dt; this.vx*=0.965; this.vy*=0.965; this.r+=18*DPR*dt; }
    draw(){ const a=clamp(this.life/1.3,0,1); const g=ctx.createRadialGradient(this.x,this.y,0,this.x,this.y,this.r); g.addColorStop(0,`rgba(200,240,255,${0.25*a})`); g.addColorStop(1,`rgba(120,200,255,0)`); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(this.x,this.y,this.r,0,TAU); ctx.fill(); }
  }
  class Fireball{
    constructor(){ this.x=world.cx; this.y=world.cy; this.r=12*DPR; this.life=0.85; }
    update(dt){ this.life-=dt; this.r+=300*dt*DPR; }
    draw(){ const a=clamp(this.life/0.85,0,1); const g=ctx.createRadialGradient(this.x,this.y,0,this.x,this.y,this.r); g.addColorStop(0,`rgba(255,200,80,${0.95*a})`); g.addColorStop(0.35,`rgba(255,120,40,${0.7*a})`); g.addColorStop(0.75,`rgba(220,40,10,${0.45*a})`); g.addColorStop(1,`rgba(120,0,0,0)`); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(this.x,this.y,this.r,0,TAU); ctx.fill(); }
  }
  function triggerCoreExplosion(){ world.flash=0.45; for(let i=0;i<20;i++) world.debris.push(new Debris()); for(let i=0;i<16;i++) world.smokes.push(new Smoke()); world.fireballs.push(new Fireball()); }

  /* ===== SFX ===== */
  let sfxAC=null; function ensureSFX(){ if(!sfxAC){ try{ const AC=window.AudioContext||window.webkitAudioContext; if(!AC) return null; sfxAC=new AC(); }catch(e){} } return sfxAC; }
  function playPulseSound(){ const ac=ensureSFX(); if(!ac) return; const o=ac.createOscillator(), g=ac.createGain(); o.type='sine'; o.frequency.setValueAtTime(640, ac.currentTime); g.gain.setValueAtTime(0.0001, ac.currentTime); g.gain.exponentialRampToValueAtTime(0.16, ac.currentTime+0.01); g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime+0.16); o.connect(g).connect(ac.destination); o.start(); o.stop(ac.currentTime+0.18); }
  function playDestroySound(){ const ac=ensureSFX(); if(!ac) return; const o=ac.createOscillator(); const g=ac.createGain(); o.type='sine'; o.frequency.setValueAtTime(220, ac.currentTime); o.frequency.exponentialRampToValueAtTime(48, ac.currentTime+0.35); g.gain.setValueAtTime(0.28, ac.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime+0.38); o.connect(g).connect(ac.destination); o.start(); o.stop(ac.currentTime+0.4);
    const nsrc=ac.createBufferSource(); const len=ac.sampleRate*0.25; const buf=ac.createBuffer(1,len,ac.sampleRate); const d=buf.getChannelData(0); for(let i=0;i<len;i++){ d[i]=(Math.random()*2-1)*Math.pow(1-i/len,2);} nsrc.buffer=buf; const bpf=ac.createBiquadFilter(); bpf.type='bandpass'; bpf.frequency.value=380; bpf.Q.value=1.2; const nGain=ac.createGain(); nGain.gain.setValueAtTime(0.22, ac.currentTime); nGain.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime+0.22); nsrc.connect(bpf).connect(nGain).connect(ac.destination); nsrc.start(); nsrc.stop(ac.currentTime+0.24); }
  function playGameOverSound(){ const ac=ensureSFX(); if(!ac) return; const o=ac.createOscillator(); const g=ac.createGain(); const lp=ac.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=900; o.type='triangle'; o.frequency.setValueAtTime(260, ac.currentTime); o.frequency.exponentialRampToValueAtTime(60, ac.currentTime+1.0); g.gain.setValueAtTime(0.3, ac.currentTime); g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime+1.2); o.connect(lp).connect(g).connect(ac.destination); o.start(); o.stop(ac.currentTime+1.3); }

  /* ===== Countdown helper ===== */
  function countdown(n, onDone){
    n=Math.max(0,Math.floor(n||3));
    const seq=[]; for(let i=n;i>0;i--) seq.push(String(i)); seq.push('Go!');
    const step=700; let idx=0;
    function tick(){ flashPop(seq[idx++]); if(idx<seq.length){ setTimeout(tick,step); } else { setTimeout(()=>{ if(typeof onDone==='function') onDone(); },380); } }
    tick();
  }

  /* ===== Game flow ===== */
  function startGame(){
    state='playing';
    world.t=0; world.level=1; world.nextLevelT=20; world.score=0; world.hp=3;
    world.pulses.length=0; world.shards.length=0; world.notes.length=0; world.particles.length=0;
    world.debris.length=0; world.smokes.length=0; world.fireballs.length=0;
    world.charges=3; world.chargeFill=3; ui.levelDisplay.textContent='Level: '+world.level;
    ui.menu.style.display='none'; ui.over.classList.remove('show'); ui.over.style.display='none'; ui.backdrop.style.display='none'; ui.curtain.classList.remove('show');
    countdown(3, ()=>{ try{ BGM.start(); BGM.fadeCrackle(0.22,400); }catch(e){} finally { loop(performance.now()); } });
  }
  const easeOutCubic=x=>1-Math.pow(1-x,3);
  function animateNumber(el,to,ms=600){
    const start=performance.now(), from=0;
    function step(t){ const k=Math.min(1,(t-start)/ms); el.textContent=Math.round(from+(to-from)*easeOutCubic(k)); if(k<1) requestAnimationFrame(step); }
    requestAnimationFrame(step);
  }
  function gameOver(){
    state='over';
    world.best=Math.max(world.best||0, Math.round(world.score));
    safeStorage.set('aegis-hi', world.best);
    world.pulses.length=0; world.fireballs.length=0;
    ui.backdrop.style.display='block'; ui.over.style.display='block'; ui.over.classList.add('show');
    animateNumber(ui.finalScore, Math.round(world.score)); ui.finalHigh.textContent=world.best;
    playGameOverSound(); try{ BGM.fadeCrackle(0,350); }catch(e){} BGM.stop();
  }
  function damage(){ burst(world.cx,world.cy,'#ff6a6a'); triggerCoreExplosion(); world.shake=14; world.hp--; ui.hp.textContent=world.hp; playDestroySound(); if(world.hp<=0) setTimeout(gameOver,60); }
  function addScore(x){ world.score+=x; flashPop('+'+x); }

  /* ===== Spawners ===== */
  let shardTimer=0, noteTimer=0;
  function spawnShard(){ world.shards.push(new Shard()); }
  function spawnNote(){ world.notes.push(new Note()); }

  /* ===== Update / Draw loop ===== */
  let rafId=null;
  function loop(now){
    if(state!=='playing') return;
    world.dt=Math.min(0.033,(now-world.last)/1000); world.last=now; world.t+=world.dt;
    update(world.dt); draw(); rafId=requestAnimationFrame(loop);
  }
  function update(dt){
    world.chargeFill=clamp(world.chargeFill+world.chargeRegen*dt,0,3);
    world.charges=Math.floor(world.chargeFill+1e-6);
    shardTimer-=dt; if(shardTimer<=0){ spawnShard(); shardTimer=Math.max(0.86-world.level*0.05,0.26); }
    noteTimer-=dt; if(noteTimer<=0){ spawnNote(); noteTimer=rand(4.2,7); }
    if(world.t>=world.nextLevelT){ world.level++; world.nextLevelT+=22; ui.levelDisplay.textContent='Level: '+world.level; }

    for(const p of world.pulses) p.update(dt);
    for(const s of world.shards) s.update(dt);
    for(const n of world.notes) n.update(dt);
    for(const p of world.particles) p.update(dt);
    for(const d of world.debris) d.update(dt);
    for(const s of world.smokes) s.update(dt);
    for(const f of world.fireballs) f.update(dt);

    for(const ring of world.pulses){
      const rr=ring.r, w=ring.width*0.5+1*DPR, rmin=rr-w, rmax=rr+w;
      for(const s of world.shards){
        if(!s.alive||s.hitCooldown>0) continue;
        const d=dist(s.x,s.y,world.cx,world.cy);
        if(d>=rmin-s.r && d<=rmax+s.r){
          const ang=Math.atan2(s.y-world.cy, s.x-world.cx);
          const spd=Math.hypot(s.vx,s.vy);
          s.vx=Math.cos(ang)*(spd*1.6); s.vy=Math.sin(ang)*(spd*1.6);
          s.reflected=true; s.hitCooldown=0.1;
          burst(s.x,s.y,'#9fe9ff'); addScore(10);
        }
      }
      for(const n of world.notes){
        if(!n.alive) continue;
        const d=dist(n.x,n.y,world.cx,world.cy);
        if(d>=rmin-n.r && d<=rmax+n.r){
          n.alive=false; addScore(30);
          world.chargeFill=clamp(world.chargeFill+0.5,0,3);
          burst(n.x,n.y,'#54f0a6');
        }
      }
    }

    world.pulses=world.pulses.filter(p=>p.alive);
    world.shards=world.shards.filter(s=>s.alive);
    world.notes=world.notes.filter(n=>n.alive);
    world.particles=world.particles.filter(p=>p.life>0);
    world.debris=world.debris.filter(d=>d.life>0);
    world.smokes=world.smokes.filter(s=>s.life>0);
    world.fireballs=world.fireballs.filter(f=>f.life>0);

    ui.score.textContent='Score: '+Math.round(world.score);
    ui.time.textContent=Math.floor(world.t)+'s';
    ui.hi.textContent=world.best||0;
    ui.hp.textContent=world.hp;
    const fill=world.chargeFill; for(let i=0;i<3;i++){ const amount=clamp(fill-i,0,1); ui.pips[i].style.width=(amount*100)+'%'; }
  }
  function draw(){
    if(world.shake>0){ world.shake-=0.85; ctx.setTransform(1,0,0,1,(Math.random()-0.5)*world.shake,(Math.random()-0.5)*world.shake); }
    else ctx.setTransform(1,0,0,1,0,0);
    drawBackdrop(world.t);

    const g=ctx.createRadialGradient(world.cx,world.cy,2, world.cx,world.cy, world.centerR*3.0);
    g.addColorStop(0,'#ffe9c9'); g.addColorStop(1,'rgba(255,220,160,0)');
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(world.cx,world.cy,world.centerR*3.0,0,TAU); ctx.fill();
    ctx.fillStyle='#fff5e6'; ctx.beginPath(); ctx.arc(world.cx,world.cy,world.centerR,0,TAU); ctx.fill();

    for(const p of world.pulses) p.draw();
    for(const s of world.shards) s.draw();
    for(const n of world.notes) n.draw();
    for(const d of world.debris) d.draw();
    for(const s of world.smokes) s.draw();
    for(const f of world.fireballs) f.draw();
    for(const p of world.particles) p.draw();

    ctx.setTransform(1,0,0,1,0,0);
  }

  function burst(x,y,c){ for(let i=0;i<14;i++) world.particles.push(new Particle(x,y,c)); }
  function flashPop(text){ const el=ui.pop; el.textContent=text; el.classList.remove('show'); void el.offsetWidth; el.classList.add('show'); }

  /* ===== Input & controls ===== */
  function firePulse(){ if(state!=='playing') return; if(world.charges<=0) return; world.chargeFill=clamp(world.chargeFill-1,0,3); world.pulses.push(new Pulse()); playPulseSound(); }
  canvas.addEventListener('mousedown', firePulse);
  canvas.addEventListener('touchstart', e=>{ firePulse(); e.preventDefault(); }, {passive:false});
  window.addEventListener('keydown', e=>{ if(e.code==='Space') { firePulse(); e.preventDefault(); } if(e.key==='p'||e.key==='P'){ togglePause(); } });

  ui.muteBtn.addEventListener('click', ()=> BGM.toggle());
  ui.pauseBtn.addEventListener('click', ()=> togglePause());
  ui.resumeBtn.addEventListener('click', ()=> togglePause(true));

  function togglePause(resume=false){
    if(state==='playing' && !resume){
      state='paused'; ui.curtain.classList.add('show');
      try{ BGM.fadeCrackle(0,300); }catch(e){} BGM.stop();
      if(rafId){ cancelAnimationFrame(rafId); rafId=null; }
    } else if(state==='paused' || resume){
      state='playing'; ui.curtain.classList.remove('show');
      try{ BGM.start(); BGM.fadeCrackle(0.22,400); }catch(e){}
      world.last=performance.now(); rafId=requestAnimationFrame(loop);
    }
  }

  /* ===== Resize / Visibility / Init ===== */
  function resizeCanvas(){
    DPR = computeDPR();
    const { clientWidth:w, clientHeight:h } = canvas;
    canvas.width=Math.max(300, w)*DPR;
    canvas.height=Math.max(520, h)*DPR;
    world.w=canvas.width; world.h=canvas.height;
    world.cx=world.w*0.5; world.cy=world.h*0.55;
    world.centerR = 19*DPR;
    ctx.imageSmoothingEnabled=false; initStars();
  }
  window.addEventListener('resize', resizeCanvas);
  window.addEventListener('orientationchange', resizeCanvas);
  resizeCanvas(); ui.hi.textContent=world.best || 0;

  document.addEventListener('visibilitychange', ()=>{ if(document.hidden && state==='playing'){ togglePause(false); } });
  ui.btnPlay.addEventListener('click', startGame);
  window.addEventListener('keydown', e=>{ if(state==='menu' && (e.code==='Space' || e.key==='Enter')){ startGame(); e.preventDefault(); } });
  ui.btnRetry.addEventListener('click', startGame);
  window.addEventListener('contextmenu', e=> e.preventDefault());
  window.addEventListener('pointerdown', function once(){ window.removeEventListener('pointerdown', once); try{ BGM.start(); BGM.stop(); }catch(e){} }, { once:true });
</script>
</body>
</html>
